name: iOS Signer Engine

on:
  repository_dispatch:
    types: [sign_ipa]

jobs:
  sign:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            git \
            g++ \
            make \
            pkg-config \
            libssl-dev \
            libminizip-dev \
            zlib1g-dev

      - name: Setup Zsign (zhlynn fork - final binary path fix)
        run: |
          git clone https://github.com/zhlynn/zsign.git
          cd zsign/build/linux
          make clean || true
          make
          sudo cp bin/zsign /usr/local/bin/zsign
          cd ../..
          zsign --version || echo "Zsign build & install successful"

      - name: Signing IPA
        run: |
          zsign \
            -k free_cert.p12 \
            -p "${{ github.event.client_payload.p12_password }}" \
            -m free_cert.mobileprovision \
            -o signed.ipa \
            original.ipa

      - name: Upload Signed IPA as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Signed_IPA
          path: signed.ipa
          retention-days: 14
