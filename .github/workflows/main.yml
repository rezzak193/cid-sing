name: iOS Signer Engine

on:
  repository_dispatch:
    types: [sign_ipa]

jobs:
  sign:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y git g++ make pkg-config libssl-dev libminizip-dev zlib1g-dev unzip

      - name: Setup Zsign
        run: |
          git clone https://github.com/zhlynn/zsign.git
          cd zsign/build/linux
          make clean || true
          make
          # Binary build/linux/bin/zsign में बनता है
          sudo cp bin/zsign /usr/local/bin/zsign
          cd ../../..
          zsign --version || echo "Zsign installed successfully"

      - name: Signing IPA
        run: |
          if [ -z "${{ github.event.client_payload.p12_password }}" ]; then
            echo "Error: Password not received from bot!"
            exit 1
          fi
          zsign -k free_cert.p12 -p "${{ github.event.client_payload.p12_password }}" -m free_cert.mobileprovision -o signed.ipa original.ipa

      - name: Create OTA Manifest
        run: |
          cat <<EOF > manifest.plist
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>items</key>
            <array>
              <dict>
                <key>assets</key>
                <array>
                  <dict>
                    <key>kind</key>
                    <string>software-package</string>
                    <key>url</key>
                    <string>https://raw.githubusercontent.com/${{ github.repository }}/main/signed.ipa</string>
                  </dict>
                </array>
                <key>metadata</key>
                <dict>
                  <key>bundle-identifier</key>
                  <string>com.example.signedapp</string>  <!-- यहाँ अपना Bundle ID डालो या नीचे extract step जोड़ो -->
                  <key>bundle-version</key>
                  <string>1.0</string>
                  <key>kind</key>
                  <string>software</string>
                  <key>title</key>
                  <string>CID Signed App</string>
                </dict>
              </dict>
            </array>
          </dict>
          </plist>
          EOF

      - name: Commit & Push Signed Files
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"
          git add signed.ipa manifest.plist
          git commit -m "Update signed IPA and OTA manifest [$(date +'%Y-%m-%d %H:%M')]" || echo "No changes to commit"
          git push origin main
